<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>파일 복호화 (ActiveX + JS Fallback)</title>
<meta http-equiv="X-UA-Compatible" content="IE=11">

<style>
body {
  font-family: "Malgun Gothic", Arial, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 20px;
  color: #222;
}
.container {
  width: 900px;
  max-width: 96%;
  margin: 0 auto;
  background: #fff;
  border: 1px solid #e1e4ea;
  padding: 18px;
  box-sizing: border-box;
  border-radius: 6px;
}
.header { overflow: hidden; margin-bottom: 12px; }
.header h1 { float:left; margin:0; font-size:20px; }
.header .info { float:right; font-size:12px; color:#666; }
.uploader {
  border: 2px dashed #cfd8e3;
  background: #fafbfc;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  position: relative;
  margin-bottom: 12px;
  border-radius: 4px;
}
.uploader.dragover {
  border-color: #6aa0ff;
  background: #f0f6ff;
}
.uploader p { margin: 6px 0; font-size:14px; color:#333; }
.controls { margin-bottom: 12px; }
.btn {
  display: inline-block;
  padding: 8px 14px;
  background: #2b7cff;
  color: #fff;
  text-decoration: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  margin-right: 8px;
}
.btn.secondary { background:#6c757d; }
.file-list { border-top:1px solid #eee; padding-top:10px; font-size:13px; }
.file-item { padding:8px 6px; border-bottom:1px dashed #eee; overflow: hidden; }
.file-item .name { float:left; width:60%; }
.file-item .status { float:right; color:#777; }
.clearfix { clear:both; }
.msg {
  margin-top:12px;
  padding:10px;
  border-radius:4px;
  background:#fffbe6;
  border:1px solid #ffe58f;
  color:#664d03;
  font-size:13px;
}
.note { margin-top:10px; font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>파일 복호화 (IE 모드용)</h1>
    <div class="info">ActiveX 사용 시도 → 실패 시 JS 처리</div>
  </div>

  <div id="uploader" class="uploader" tabindex="0">
    <p>파일을 여기에 끌어다 놓거나<br>아래 버튼으로 파일을 선택하세요.</p>
    <input id="fileInput" type="file" multiple
      style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;" />
  </div>

  <div class="controls">
    <a href="#" class="btn" id="startBtn">복호화 시작</a>
    <a href="#" class="btn secondary" id="clearBtn">목록 비우기</a>
    <span class="note">※ Edge IE 모드에서 ActiveX 복호화 지원</span>
  </div>

  <div id="list" class="file-list"></div>
  <div id="message" class="msg" style="display:none;"></div>
</div>

<script>
// ===== 유틸 =====
function $(id){ return document.getElementById(id); }

var uploader = $('uploader');
var fileInput = $('fileInput');
var list = $('list');
var startBtn = $('startBtn');
var clearBtn = $('clearBtn');
var message = $('message');
var filesArray = [];

// ===== 파일 드래그앤드롭 =====
uploader.addEventListener('dragover', function(e){
  e.preventDefault();
  if (uploader.className.indexOf('dragover') === -1)
    uploader.className += ' dragover';
});
uploader.addEventListener('dragleave', function(e){
  e.preventDefault();
  uploader.className = uploader.className.replace(' dragover','');
});
uploader.addEventListener('drop', function(e){
  e.preventDefault();
  uploader.className = uploader.className.replace(' dragover','');
  var dt = e.dataTransfer;
  if (dt && dt.files) handleFileList(dt.files);
});

// ===== 파일 선택 =====
fileInput.addEventListener('change', function(){
  handleFileList(fileInput.files);
});

// ===== 파일 목록 관리 =====
function handleFileList(fileList) {
  for (var i = 0; i < fileList.length; i++) {
    filesArray.push({ file: fileList[i], status: 'pending' });
  }
  renderList();
}
function renderList() {
  list.innerHTML = '';
  for (var i = 0; i < filesArray.length; i++) {
    var info = filesArray[i];
    var item = document.createElement('div');
    item.className = 'file-item';
    var name = document.createElement('span');
    name.className = 'name';
    name.innerText = (i+1) + '. ' + info.file.name + ' (' + Math.round(info.file.size/1024) + ' KB)';
    var status = document.createElement('span');
    status.className = 'status';
    status.innerText = info.status;
    item.appendChild(name);
    item.appendChild(status);
    item.appendChild(document.createElement('div')).className = 'clearfix';
    list.appendChild(item);
  }
}
function showMessage(text) {
  message.style.display = 'block';
  message.innerText = text;
}

// ===== ActiveX 가능 여부 =====
function isActiveXAvailable() {
  try { return !!window.ActiveXObject || "ActiveXObject" in window; }
  catch(e){ return false; }
}

// ===== IE 모드 파일 경로 파싱 =====
// 예: "C:\\Users\\me\\Desktop\\" "a.txt" "b.txt" "c.txt"
function parseIEFileInputValue(val) {
  if (!val) return [];
  var matches = val.match(/"([^"]+)"/g);
  if (!matches || matches.length === 0) return [];

  var basePath = matches[0].replace(/"/g, '');
  var results = [];

  if (!/\\$/.test(basePath)) basePath += "\\"; // 경로 끝에 \ 보정

  for (var i = 1; i < matches.length; i++) {
    var fileName = matches[i].replace(/"/g, '');
    results.push(basePath + fileName);
  }
  return results;
}

// ===== ActiveX 복호화 =====
function tryActiveXDecrypt(callback) {
  try {
    if (!isActiveXAvailable()) throw new Error('ActiveX not available');
    var val = fileInput.value;
    var paths = parseIEFileInputValue(val);
    if (paths.length === 0 && val) {
      // 단일 파일 선택 시
      paths = [val.replace(/"/g,'')];
    }
    if (paths.length === 0) throw new Error('파일 경로를 확인할 수 없습니다.');

    var xObj = new window.ActiveXObject("DSCOMCSLINK.CSLinker.1");
    xObj.CSSetLicenseKey("1111-2222-3333-4444");
    xObj.CSAddDac(3, "1;1;0;0;1;1;0");

    for (var i = 0; i < paths.length; i++) {
      xObj.CSDecryptFile(paths[i], paths[i]);
    }
    callback(null, paths.length + '개 파일 복호화 완료');
  } catch (err) {
    console.error('ActiveX 복호화 실패:', err);
    callback(err);
  }
}

// ===== JS fallback =====
function jsDecryptFile(file, callback) {
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      var result = e.target.result;
      callback(null, result);
    } catch (ex) {
      callback(ex);
    }
  };
  reader.onerror = function(){ callback(new Error('FileReader 오류')); };
  reader.readAsArrayBuffer(file);
}

// ===== 전체 처리 =====
function processAllFiles() {
  if (filesArray.length === 0) {
    showMessage('처리할 파일이 없습니다.');
    return;
  }
  showMessage('복호화 시작...');

  // IE ActiveX 처리 우선
  if (isActiveXAvailable()) {
    tryActiveXDecrypt(function(err, msg){
      if (!err) {
        for (var i = 0; i < filesArray.length; i++) filesArray[i].status = 'done (ActiveX)';
        showMessage(msg);
        renderList();
      } else {
        showMessage('ActiveX 실패 → JS 복호화로 진행');
        fallbackWithJS();
      }
    });
  } else {
    fallbackWithJS();
  }

  function fallbackWithJS() {
    var idx = 0;
    function next() {
      if (idx >= filesArray.length) {
        showMessage('JS 복호화 완료');
        renderList();
        return;
      }
      var info = filesArray[idx];
      info.status = 'processing';
      renderList();
      jsDecryptFile(info.file, function(err, result){
        info.status = err ? 'error' : 'done (JS)';
        idx++; next();
      });
    }
    next();
  }
}

// ===== 버튼 이벤트 =====
startBtn.addEventListener('click', function(e){ e.preventDefault(); processAllFiles(); });
clearBtn.addEventListener('click', function(e){ e.preventDefault(); filesArray = []; renderList(); message.style.display='none'; });

// ===== 초기 메시지 =====
renderList();
window.onload = function(){
  if (isActiveXAvailable()) {
    showMessage('ActiveX 복호화를 시도합니다. (Edge IE 모드 또는 IE11)');
  } else {
    showMessage('ActiveX를 사용할 수 없습니다. JS 복호화로 처리합니다.');
  }
};
</script>
</body>
</html>
