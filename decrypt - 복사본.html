<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>파일 복호화 (ActiveX + JS Fallback)</title>

<!-- IE 호환 -->
<meta http-equiv="X-UA-Compatible" content="IE=11">

<style>
body {
  font-family: "Malgun Gothic", Arial, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 20px;
  color: #222;
}
.container {
  width: 900px;
  max-width: 96%;
  margin: 0 auto;
  background: #fff;
  border: 1px solid #e1e4ea;
  padding: 18px;
  box-sizing: border-box;
  border-radius: 6px;
}
.header { overflow: hidden; margin-bottom: 12px; }
.header h1 { float:left; margin:0; font-size:20px; }
.header .info { float:right; font-size:12px; color:#666; }
.uploader {
  border: 2px dashed #cfd8e3;
  background: #fafbfc;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  position: relative;
  margin-bottom: 12px;
  border-radius: 4px;
}
.uploader.dragover {
  border-color: #6aa0ff;
  background: #f0f6ff;
}
.uploader p { margin: 6px 0; font-size:14px; color:#333; }
.controls { margin-bottom: 12px; }
.btn {
  display: inline-block;
  padding: 8px 14px;
  background: #2b7cff;
  color: #fff;
  text-decoration: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  margin-right: 8px;
}
.btn.secondary { background:#6c757d; }
.file-list { border-top:1px solid #eee; padding-top:10px; font-size:13px; }
.file-item { padding:8px 6px; border-bottom:1px dashed #eee; overflow: hidden; }
.file-item .name { float:left; width:60%; }
.file-item .status { float:right; color:#777; }
.clearfix { clear:both; }
.msg {
  margin-top:12px;
  padding:10px;
  border-radius:4px;
  background:#fffbe6;
  border:1px solid #ffe58f;
  color:#664d03;
  font-size:13px;
}
.note { margin-top:10px; font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>파일 복호화 (IE 모드용)</h1>
    <div class="info">ActiveX 사용 시도 → 실패 시 JS 처리</div>
  </div>

  <div id="uploader" class="uploader" tabindex="0">
    <p>파일을 여기에 끌어다 놓거나<br>아래 버튼으로 파일을 선택하세요.</p>
    <input id="fileInput" type="file" multiple
      style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;" />
  </div>

  <div class="controls">
    <a href="#" class="btn" id="startBtn">복호화 시작</a>
    <a href="#" class="btn secondary" id="clearBtn">목록 비우기</a>
    <span class="note">※ Edge IE 모드에서 ActiveX 복호화 지원</span>
  </div>

  <div id="list" class="file-list"></div>

  <div id="message" class="msg" style="display:none;"></div>
</div>

<script>
// 유틸
function $(id){ return document.getElementById(id); }

var uploader = $('uploader');
var fileInput = $('fileInput');
var list = $('list');
var startBtn = $('startBtn');
var clearBtn = $('clearBtn');
var message = $('message');

var filesArray = [];

// 파일 드래그앤드롭
uploader.addEventListener('dragover', function(e){
  e.preventDefault();
  if (uploader.className.indexOf('dragover') === -1)
    uploader.className += ' dragover';
});
uploader.addEventListener('dragleave', function(e){
  e.preventDefault();
  uploader.className = uploader.className.replace(' dragover','');
});
uploader.addEventListener('drop', function(e){
  e.preventDefault();
  uploader.className = uploader.className.replace(' dragover','');
  var dt = e.dataTransfer;
  if (dt && dt.files) handleFileList(dt.files);
});

// 파일 선택 이벤트
fileInput.addEventListener('change', function(e){
  handleFileList(fileInput.files);
});

// 파일 목록 관리
function handleFileList(fileList) {
  for (var i = 0; i < fileList.length; i++) {
    var f = fileList[i];
    filesArray.push({ file: f, status: 'pending' });
  }
  renderList();
}
function renderList() {
  list.innerHTML = '';
  for (var i = 0; i < filesArray.length; i++) {
    var info = filesArray[i];
    var item = document.createElement('div');
    item.className = 'file-item';
    var name = document.createElement('span');
    name.className = 'name';
    name.innerText = (i+1) + '. ' + info.file.name + ' (' + Math.round(info.file.size/1024) + ' KB)';
    var status = document.createElement('span');
    status.className = 'status';
    status.innerText = info.status;
    item.appendChild(name);
    item.appendChild(status);
    item.appendChild(document.createElement('div')).className = 'clearfix';
    list.appendChild(item);
  }
}
function showMessage(text) {
  message.style.display = 'block';
  message.innerText = text;
}

// ActiveX 사용 가능 여부
function isActiveXAvailable() {
  try { return !!window.ActiveXObject || "ActiveXObject" in window; }
  catch(e){ return false; }
}

/* ✅ ActiveX 복호화 로직 */
function tryActiveXDecrypt(file, callback) {
  try {
    if (!isActiveXAvailable()) throw new Error('ActiveX not available');

    // ActiveX 객체 생성
    var xObj = new window.ActiveXObject("DSCOMCSLINK.CSLinker.1");
    // 라이선스 및 DAC 설정
    xObj.CSSetLicenseKey("1111-2222-3333-4444");
    xObj.CSAddDac(3, "1;1;0;0;1;1;0");

    // IE 모드에서는 fileInput.value로 경로 접근 가능 (보안설정 필요)
    var filePath = fileInput.value;
    if (!filePath) throw new Error('파일 경로를 확인할 수 없습니다 (IE 모드 필요)');

    // 복호화 수행
    var result = xObj.CSDecryptFile(filePath, filePath);

    callback(null, result);
  } catch (err) {
    console.error('ActiveX 복호화 실패:', err);
    callback(err);
  }
}

// JS fallback (ActiveX 실패 시)
function jsDecryptFile(file, callback) {
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      // 실제 복호화 로직을 여기에 구현 가능
      var result = e.target.result;
      callback(null, result);
    } catch (ex) {
      callback(ex);
    }
  };
  reader.onerror = function(){ callback(new Error('FileReader 오류')); };
  reader.readAsArrayBuffer(file);
}

// 전체 처리
function processAllFiles() {
  if (filesArray.length === 0) {
    showMessage('처리할 파일이 없습니다.');
    return;
  }
  showMessage('복호화 시작...');
  var idx = 0;

  function next() {
    if (idx >= filesArray.length) {
      showMessage('모든 파일 처리 완료.');
      renderList();
      return;
    }

    var info = filesArray[idx];
    info.status = 'processing';
    renderList();

    tryActiveXDecrypt(info.file, function(err, result){
      if (!err) {
        info.status = 'done (ActiveX)';
        info.result = result;
        idx++; next();
      } else {
        jsDecryptFile(info.file, function(err2, result2){
          if (!err2) {
            info.status = 'done (JS)';
            info.result = result2;
          } else {
            info.status = 'error';
          }
          idx++; next();
        });
      }
    });
  }
  next();
}

// 버튼 이벤트
startBtn.addEventListener('click', function(e){ e.preventDefault(); processAllFiles(); });
clearBtn.addEventListener('click', function(e){ e.preventDefault(); filesArray = []; renderList(); message.style.display='none'; });

// 초기화
renderList();
window.onload = function(){
  if (isActiveXAvailable()) {
    showMessage('ActiveX 복호화를 시도합니다. (Edge IE 모드 또는 IE11에서 실행)');
  } else {
    showMessage('ActiveX를 사용할 수 없습니다. JS 복호화로 처리합니다.');
  }
};
</script>
</body>
</html>









<script>
function tryActiveXDecrypt(filePaths, callback) {
  try {
    if (!isActiveXAvailable()) throw new Error('ActiveX not available');

    var xObj = new window.ActiveXObject("DSCOMCSLINK.CSLinker.1");
    xObj.CSSetLicenseKey("1111-2222-3333-4444");
    xObj.CSAddDac(3, "1;1;0;0;1;1;0");

    // filePaths: 실제 경로 배열
    for (var i = 0; i < filePaths.length; i++) {
      var p = filePaths[i];
      if (!p) continue;
      xObj.CSDecryptFile(p, p);
    }
    callback(null, 'ok');
  } catch (err) {
    console.error('ActiveX 복호화 실패:', err);
    callback(err);
  }
}

function extractFilePathsFromValue(val) {
  if (!val) return [];
  // 큰따옴표로 묶인 파일 경로들을 분리
  // 예: "C:\a.txt" "C:\b.txt" "C:\c.txt"
  var matches = val.match(/"([^"]+)"/g);
  if (matches) {
    return matches.map(function(s){ return s.replace(/"/g, ''); });
  } else {
    // 따옴표가 없는 단일 파일 경로 케이스
    return [val];
  }
}

function processAllFiles() {
  if (filesArray.length === 0) {
    showMessage('처리할 파일이 없습니다.');
    return;
  }

  showMessage('복호화 시작...');
  var val = fileInput.value;
  var realPaths = extractFilePathsFromValue(val);

  if (realPaths.length > 0 && isActiveXAvailable()) {
    // IE모드 + 실제 경로 접근 가능 → ActiveX 복호화
    tryActiveXDecrypt(realPaths, function(err){
      if (!err) {
        for (var i = 0; i < filesArray.length; i++) {
          filesArray[i].status = 'done (ActiveX)';
        }
        showMessage('ActiveX 복호화 완료 (' + realPaths.length + '개)');
        renderList();
      } else {
        showMessage('ActiveX 실패 → JS fallback으로 진행');
        fallbackWithJS();
      }
    });
  } else {
    // JS fallback
    fallbackWithJS();
  }

  function fallbackWithJS() {
    var idx = 0;
    function next() {
      if (idx >= filesArray.length) {
        showMessage('모든 파일 JS 복호화 완료.');
        renderList();
        return;
      }
      var info = filesArray[idx];
      info.status = 'processing';
      renderList();
      jsDecryptFile(info.file, function(err, result){
        info.status = err ? 'error' : 'done (JS)';
        idx++; next();
      });
    }
    next();
  }
}
</script>


